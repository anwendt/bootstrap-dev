#!/bin/bash
set -e

echo "ğŸ”’ [1/4] git-secrets: scanning for AWS and custom patterns..."
git secrets --scan || {
  echo "âŒ git-secrets found secrets."
  exit 1
}

echo "ğŸ•µï¸ [2/4] gitleaks: scanning using built-in rules..."
gitleaks detect --no-git --redact --exit-code 1 || {
  echo "âŒ gitleaks found secrets."
  exit 1
}

echo "ğŸ§  [3/4] trufflehog: entropy + pattern scan..."
trufflehog filesystem . --fail || {
  echo "âŒ trufflehog found potential secrets."
  exit 1
}

echo "ğŸ” [4/4] checking if secrets.yaml is encrypted with SOPS..."

FILES=$(git diff --cached --name-only | grep -E 'secrets.*\.ya?ml$') || true

if [[ -z "$FILES" ]]; then
  echo "âœ… No secrets.yaml files staged. Skipping SOPS check."
else
  for file in $FILES; do
    if grep -q '^sops:' "$file"; then
      echo "âœ… $file is encrypted with SOPS."
    else
      echo "âŒ $file is NOT encrypted with SOPS. Commit blocked!"
      exit 1
    fi
  done
fi

echo "âœ… All secret scans passed. Proceeding with commit."
