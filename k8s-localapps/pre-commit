#!/bin/bash
set -e

echo "🔒 [1/4] git-secrets: scanning for AWS and custom patterns..."
git secrets --scan || {
  echo "❌ git-secrets found secrets."
  exit 1
}

echo "🕵️ [2/4] gitleaks: scanning using built-in rules..."
gitleaks detect --no-git --redact --exit-code 1 || {
  echo "❌ gitleaks found secrets."
  exit 1
}

echo "🧠 [3/4] trufflehog: entropy + pattern scan..."
trufflehog filesystem . --fail || {
  echo "❌ trufflehog found potential secrets."
  exit 1
}

echo "🔐 [4/4] checking if secrets.yaml is encrypted with SOPS..."

FILES=$(git diff --cached --name-only | grep -E 'secrets.*\.ya?ml$') || true

if [[ -z "$FILES" ]]; then
  echo "✅ No secrets.yaml files staged. Skipping SOPS check."
else
  for file in $FILES; do
    if grep -q '^sops:' "$file"; then
      echo "✅ $file is encrypted with SOPS."
    else
      echo "❌ $file is NOT encrypted with SOPS. Commit blocked!"
      exit 1
    fi
  done
fi

echo "✅ All secret scans passed. Proceeding with commit."
